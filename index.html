<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MenuCraft - Digital Menu</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">

    <script>
        // Restaurant Order Notification System
// Add to your firebase-service.js or index.html

const sendOrderNotifications = async (orderData, cart, total) => {
    const restaurantPhone = "00923347507666"; // Your restaurant WhatsApp number
    const restaurantEmail = "orders@restaurant.com"; // Your restaurant email

    // Format order for restaurant
    const orderMessage = `
🆕 NEW ORDER - ${orderData.orderNumber || Date.now()}

📋 ITEMS:
${cart.map(item => `${item.quantity}x ${item.name} - $${(item.price * item.quantity).toFixed(2)}`).join('\n')}

💰 TOTAL: $${total.toFixed(2)}

👤 CUSTOMER:
${orderData.name} | ${orderData.phone}
${orderData.address || 'No address provided'}

${orderData.specialInstructions ? `📝 NOTES: ${orderData.specialInstructions}` : ''}

⏰ ${new Date().toLocaleString()}
    `.trim();

    // 1. WhatsApp notification to restaurant
    const whatsappURL = `https://wa.me/${restaurantPhone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(orderMessage)}`;
    
    // 2. Email notification (requires email service)
    const emailSubject = `New Order - ${orderData.name}`;
    const emailBody = orderMessage.replace(/\n/g, '%0D%0A');
    const emailURL = `mailto:${restaurantEmail}?subject=${emailSubject}&body=${emailBody}`;

    // 3. Print-friendly version
    const printOrder = () => {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head><title>Order ${orderData.orderNumber}</title></head>
                <body style="font-family: monospace; padding: 20px;">
                    <h1>NEW ORDER</h1>
                    <pre>${orderMessage}</pre>
                </body>
            </html>
        `);
        printWindow.print();
    };

    // 4. Browser notification (requires permission)
    const showBrowserNotification = () => {
        if ("Notification" in window && Notification.permission === "granted") {
            new Notification(`New Order from ${orderData.name}`, {
                body: `$${total.toFixed(2)} - ${cart.length} items`,
                icon: '/favicon.ico'
            });
        }
    };

    // Send notifications
    try {
        // Auto-open WhatsApp (restaurant staff can send manually)
        window.open(whatsappURL, '_blank');
        
        // Show browser notification
        showBrowserNotification();
        
        // Offer additional options
        setTimeout(() => {
            if (confirm('Send email copy?')) {
                window.open(emailURL, '_blank');
            }
        }, 1000);

        setTimeout(() => {
            if (confirm('Print order?')) {
                printOrder();
            }
        }, 2000);

    } catch (error) {
        console.error('Notification error:', error);
    }
};

// Real-time order monitoring for admin panel
const setupOrderMonitoring = (firebaseService) => {
    // Request notification permission
    if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
    }

    // Listen for new orders in real-time
    window.db.collection('orders')
        .where('status', '==', 'pending')
        .orderBy('createdAt', 'desc')
        .limit(1)
        .onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === 'added') {
                    const order = change.doc.data();
                    
                    // Play notification sound
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LNeSUGLIHO8diJOQgZZ7zs559NEAxPqOPwtmMcBjiS1/LNeSUGLIHO8tiJOQgZZ7vs559NEAxPp+PwtmMcBjmS1/LNeSUGLIHO8tiJOQgZZ7zs559NEAxPp+PwtmMcBzmS1/LNeSUGLIHO8tiJOQgZZ7zs559NEAxPp+PwtmMcBzmS1/LNeSUGLIHO8tiJOQgZZ7zs559N');
                    audio.play().catch(() => {}); // Ignore if audio fails
                    
                    // Show notification
                    if (Notification.permission === "granted") {
                        new Notification(`🔔 New Order!`, {
                            body: `From: ${order.customerInfo?.name}\nTotal: $${order.total}`,
                            icon: '/favicon.ico'
                        });
                    }
                }
            });
        });
};

// Update your handleCheckout function:
const handleCheckout = async (customerInfo) => {
    const order = {
        customerInfo,
        items: cart.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            quantity: item.quantity
        })),
        total: getCartTotal(),
        specialInstructions: customerInfo.specialInstructions
    };

    try {
        const result = await firebaseService.createOrder(order);
        
        // Send notifications to restaurant
        sendOrderNotifications({
            ...customerInfo,
            orderNumber: result.orderNumber || result.id
        }, cart, getCartTotal());
        
        alert(`Order placed! Order #${result.orderNumber || result.id}`);
        setCart([]);
        setShowCheckout(false);
    } catch (error) {
        console.error('Error placing order:', error);
        throw error;
    }
};
    </script>
</head>
<body>
    <div id="root">
        <div class="min-h-screen flex items-center justify-center bg-gray-50">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">Loading MenuCraft...</p>
            </div>
        </div>
    </div>
    
    <!-- Load dependencies in correct order -->
    <script src="config/firebase-config.js?v=2"></script>
    <script src="js/utils.js?v=2"></script>
    <script src="js/firebase-service.js?v=2"></script>
    <script src="js/components/shared-components.js?v=2"></script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { getRestaurantInfo, DEFAULT_CATEGORIES, formatCurrency, EmptyState, LoadingSpinner, Icons } = window.MenuCraftUtils;
        const { CheckoutForm, CartItem, MenuItemCard, CategoryNavigation } = window.MenuCraftComponents;

        // Customer Menu Component
        const CustomerMenu = () => {
            const [tenantInfo, setTenantInfo] = useState(null);
            const [firebaseService, setFirebaseService] = useState(null);
            const [selectedCategory, setSelectedCategory] = useState('all');
            const [cart, setCart] = useState([]);
            const [showCheckout, setShowCheckout] = useState(false);
            const [menuItems, setMenuItems] = useState([]);
            const [buttonStates, setButtonStates] = useState({});
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [categories, setCategories] = useState([]);

// Add this useEffect to load real categories
useEffect(() => {
const loadCategories = async () => {
    if (firebaseService) {
        try {
            const cats = await firebaseService.getCategories();
            const activeCategories = cats.filter(cat => cat.isActive);
            setCategories([
                { id: 'all', name: 'All Items', icon: '🍽️' },
                ...activeCategories
            ]);
        } catch (error) {
            console.error('Error loading categories:', error);
            setCategories([{ id: 'all', name: 'All Items', icon: '🍽️' }]);
        }
    }
};
    loadCategories();
}, [firebaseService]);

            // Initialize
            useEffect(() => {
                console.log('Initializing CustomerMenu...');
                const restaurant = getRestaurantInfo(); 
                setTenantInfo(restaurant);
                setFirebaseService(new window.FirebaseService());
            }, []);

            // Load menu items
            useEffect(() => {
                if (firebaseService) {
                    console.log('Firebase service ready, loading menu items...');
                    loadMenuItems();
                }
            }, [firebaseService]);

            const loadMenuItems = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    console.log('Loading menu items from Firebase...');
                    const items = await firebaseService.getMenuItems();
                    console.log('Loaded items:', items);
                    setMenuItems(items);
                } catch (error) {
                    console.error('Error loading menu items:', error);
                    setError('Failed to load menu. Please try again.');
                } finally {
                    setLoading(false);
                }
            };

            const addToCart = async (item) => {
                if (!item.inStock) return;
                
                setButtonStates(prev => ({ ...prev, [item.id]: 'adding' }));
                
                // Simulate adding delay
                await new Promise(resolve => setTimeout(resolve, 500));

                const existingItem = cart.find(cartItem => cartItem.id === item.id);
                if (existingItem) {
                    setCart(cart.map(cartItem => 
                        cartItem.id === item.id 
                            ? { ...cartItem, quantity: cartItem.quantity + 1 }
                            : cartItem
                    ));
                } else {
                    setCart([...cart, { ...item, quantity: 1 }]);
                }

                setButtonStates(prev => ({ ...prev, [item.id]: 'added' }));

                setTimeout(() => {
                    setButtonStates(prev => ({ ...prev, [item.id]: 'normal' }));
                }, 2000);
            };

            const updateQuantity = (id, change) => {
                setCart(cart.map(item => {
                    if (item.id === id) {
                        const newQuantity = item.quantity + change;
                        return newQuantity > 0 ? { ...item, quantity: newQuantity } : null;
                    }
                    return item;
                }).filter(Boolean));
            };

            const removeFromCart = (id) => {
                setCart(cart.filter(item => item.id !== id));
            };

            const getCartTotal = () => {
                return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            };

            const getCartItemCount = () => {
                return cart.reduce((total, item) => total + item.quantity, 0);
            };

            const getFilteredItems = () => {
                if (selectedCategory === 'all') {
                    return menuItems;
                }
                return menuItems.filter(item => item.category === selectedCategory);
            };

            const handleCheckout = async (customerInfo) => {
                const order = {
                    customerInfo,
                    items: cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity
                    })),
                    total: getCartTotal(),
                    specialInstructions: customerInfo.specialInstructions
                };

                try {
                    const result = await firebaseService.createOrder(order);

                        sendOrderNotifications({
            ...customerInfo,
            orderNumber: result.orderNumber || result.id
        }, cart, getCartTotal());


                    alert(`Order placed successfully! Order Number: ${result.orderNumber || result.id}`);
                    setCart([]);
                    setShowCheckout(false);
                } catch (error) {
                    console.error('Error placing order:', error);
                    throw error; // Let CheckoutForm handle the error
                }
            };

            if (loading) {
                return React.createElement('div', { 
                    className: 'min-h-screen flex items-center justify-center bg-gray-50' 
                },
                    React.createElement('div', { className: 'text-center' },
                        React.createElement(LoadingSpinner, { size: 48 }),
                        React.createElement('p', { className: 'text-gray-600 mt-4' }, 'Loading menu...')
                    )
                );
            }

            return React.createElement('div', { className: 'min-h-screen bg-gray-50' },
                // Header
                React.createElement('div', { className: 'bg-white shadow-sm' },
                    React.createElement('div', { className: 'max-w-7xl mx-auto px-4 py-6' },
                        React.createElement('div', { className: 'text-center' },
                            React.createElement('h1', { 
                                className: 'text-4xl md:text-5xl font-bold text-gray-800 mb-3' 
                            }, tenantInfo?.displayName || 'Restaurant Menu'),
                            React.createElement('div', { className: 'w-20 h-1 bg-orange-500 mx-auto mb-4' }),
                            React.createElement('p', { 
                                className: 'text-gray-600 max-w-2xl mx-auto text-sm md:text-base' 
                            },
                                'Experience culinary excellence with our carefully crafted menu featuring the finest ingredients and authentic flavors.'
                            )
                        )
                    )
                ),

                // Category Navigation
               React.createElement(CategoryNavigation, {
                    categories: categories,
                    selectedCategory,
                    onSelectCategory: setSelectedCategory
                }),

                // Main Content
                React.createElement('div', { className: 'max-w-7xl mx-auto px-4 py-6' },
                    React.createElement('div', { className: 'flex flex-col lg:flex-row gap-6' },
                        // Menu Items Section
                        React.createElement('div', { className: 'flex-1 min-w-0' },
                            React.createElement('div', { className: 'mb-6' },
                                React.createElement('h2', { 
                                    className: 'text-xl md:text-2xl font-semibold text-gray-800 capitalize mb-2' 
                                },
                                    selectedCategory === 'all' ? 'All Items' : 
                                    categories.find(c => c.id === selectedCategory)?.name
                                ),
                                React.createElement('p', { className: 'text-gray-600' }, 
                                    `${getFilteredItems().length} items`
                                )
                            ),

                            // Error State
                            error ? React.createElement('div', { 
                                className: 'bg-red-50 border border-red-200 rounded-lg p-6 text-center' 
                            },
                                React.createElement('p', { className: 'text-red-800 mb-4' }, error),
                                React.createElement('button', {
                                    onClick: loadMenuItems,
                                    className: 'bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700'
                                }, 'Try Again')
                            ) :

                            // Menu Items Grid
                            getFilteredItems().length === 0 ? 
                                React.createElement(EmptyState, {
                                    title: 'No Items Available',
                                    message: selectedCategory === 'all' ? 
                                        'This restaurant hasn\'t added any menu items yet. Try adding items from the admin panel.' :
                                        `No items found in ${categories.find(c => c.id === selectedCategory)?.name} category.`,
                                    actionText: selectedCategory !== 'all' ? 'View All Items' : 'Go to Admin Panel',
                                    onAction: selectedCategory !== 'all' ? 
                                        () => setSelectedCategory('all') : 
                                        () => window.open('admin.html', '_blank')
                                }) :
                                React.createElement('div', { 
                                    className: 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4' 
                                },
                                    getFilteredItems().map(item =>
                                        React.createElement(MenuItemCard, {
                                            key: item.id,
                                            item,
                                            onAddToCart: addToCart,
                                            buttonState: buttonStates[item.id] || 'normal',
                                            isLoading: buttonStates[item.id] === 'adding'
                                        })
                                    )
                                )
                        ),

                        // Cart Sidebar
                        React.createElement('div', { className: 'w-full lg:w-80 lg:flex-shrink-0' },
                            React.createElement('div', { 
                                className: 'bg-white rounded-lg shadow-sm border lg:sticky lg:top-6' 
                            },
                                React.createElement('div', { className: 'p-4 border-b' },
                                    React.createElement('h3', { className: 'text-lg font-semibold' }, 
                                        `Your Order (${getCartItemCount()})`
                                    )
                                ),
                                
                                React.createElement('div', { className: 'p-4' },
                                    cart.length === 0 ? 
                                        React.createElement('div', { className: 'text-center py-8' },
                                            React.createElement('div', { className: 'text-4xl mb-2' }, '🛒'),
                                            React.createElement('p', { 
                                                className: 'text-gray-600 text-sm' 
                                            }, 'Your cart is empty'),
                                            React.createElement('p', { 
                                                className: 'text-gray-500 text-xs mt-1' 
                                            }, 'Add items from the menu to get started')
                                        ) :
                                        React.createElement(React.Fragment, null,
                                            React.createElement('div', { 
                                                className: 'max-h-96 overflow-y-auto space-y-3 mb-4' 
                                            },
                                                cart.map(item =>
                                                    React.createElement(CartItem, {
                                                        key: item.id,
                                                        item,
                                                        onUpdateQuantity: updateQuantity,
                                                        onRemove: removeFromCart
                                                    })
                                                )
                                            ),

                                            React.createElement('div', { className: 'border-t pt-4' },
                                                React.createElement('div', { 
                                                    className: 'flex justify-between items-center text-lg font-semibold mb-4' 
                                                },
                                                    React.createElement('span', null, 'Total:'),
                                                    React.createElement('span', { 
                                                        className: 'text-orange-600' 
                                                    }, formatCurrency(getCartTotal()))
                                                ),
                                                
                                                React.createElement('button', {
                                                    onClick: () => setShowCheckout(true),
                                                    className: 'w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-colors font-medium'
                                                }, 'Proceed to Checkout')
                                            )
                                        )
                                )
                            )
                        )
                    )
                ),

                // Admin Access Link (for testing)
                React.createElement('div', { 
                    className: 'fixed bottom-4 right-4 z-50' 
                },
                    React.createElement('a', {
                        href: 'admin.html',
                        target: '_blank',
                        className: 'bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-blue-600 transition-colors text-sm'
                    }, '⚙️ Admin Panel')
                ),

                // Checkout Modal
                showCheckout && React.createElement(CheckoutForm, {
                    cart: cart,
                    total: getCartTotal(),
                    onClose: () => setShowCheckout(false),
                    onSubmit: handleCheckout
                })
            );
        };

        // Wait for all dependencies to load
        window.addEventListener('load', () => {
            console.log('Window loaded, checking dependencies...');
            
            // Check if all dependencies are loaded
            if (window.MenuCraftUtils && window.MenuCraftComponents && window.FirebaseService) {
                console.log('All dependencies loaded, rendering app...');
                ReactDOM.render(React.createElement(CustomerMenu), document.getElementById('root'));
            } else {
                console.error('Missing dependencies:', {
                    MenuCraftUtils: !!window.MenuCraftUtils,
                    MenuCraftComponents: !!window.MenuCraftComponents,
                    FirebaseService: !!window.FirebaseService
                });
                
                // Show error message
                document.getElementById('root').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-red-50">
                        <div class="text-center p-8">
                            <h1 class="text-2xl font-bold text-red-800 mb-4">Loading Error</h1>
                            <p class="text-red-600 mb-4">Failed to load required files. Please check:</p>
                            <ul class="text-left text-red-600 space-y-1">
                                <li>• config/firebase-config.js</li>
                                <li>• js/utils.js</li>
                                <li>• js/firebase-service.js</li>
                                <li>• js/components/shared-components.js</li>
                            </ul>
                            <button onclick="location.reload()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                                Reload Page
                            </button>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>